# 채팅 기능 개선 계획

## 테스터 피드백 분석 및 해결 방안

### 1. {{user}} 이름 문제
**문제**: 이름을 입력했는데도 구글 닉네임으로 표시됨
**원인**: `user_metadata.name` 대신 `profiles.name`을 사용해야 함
**해결**:
- `app/features/chat/api/chat.tsx`에서 profiles 테이블 조인하여 실제 이름 가져오기
- 시스템 프롬프트에 `{{user}}` 대신 실제 이름 사용

### 2. 이미지 태그 출력 문제
**문제**: 마크다운 이미지 태그가 렌더링되지 않음
**원인**: 현재 `whitespace-pre-wrap`만 사용하여 마크다운 파싱 없음
**해결**:
- `react-markdown` 또는 `marked` 라이브러리 추가
- 메시지 렌더링 시 마크다운 파싱 적용
- 이미지 태그를 `<img>` 태그로 변환

### 3. 유저 사칭 현상
**문제**: AI가 사용자처럼 말하는 문제
**원인**: 시스템 프롬프트에 명확한 지시 부족
**해결**:
- 시스템 프롬프트에 "절대 사용자의 입장에서 말하지 마라" 지시 추가
- "항상 캐릭터의 입장에서만 응답하라" 강조
- 예시 대화에 유저 사칭 방지 예시 추가

### 4. 캐릭터 설정 일관성
**문제**: 일부 캐릭터는 설정이 적용되고, 일부는 안 됨
**원인**: 
- `system_prompt`가 null이거나 비어있는 경우
- `example_dialogues`가 없는 경우
**해결**:
- 캐릭터 조회 시 `system_prompt` null 체크
- 기본값 제공 또는 에러 처리
- `example_dialogues`를 시스템 프롬프트에 포함

### 5. 텍스트 잘림 문제
**문제**: 스트리밍 중 텍스트가 중간에 잘림
**원인**:
- 스트리밍 완료 전에 저장되는 경우
- 버퍼링 문제
**해결**:
- `result.textStream` 완료 대기 확인
- `fullResponse`가 완전히 수집되었는지 검증
- 클라이언트 측에서도 스트리밍 완료 확인

### 6. 문체 일관성 문제
**문제**: 캐릭터 설정과 다른 문체로 생성됨
**원인**:
- 시스템 프롬프트가 충분히 강력하지 않음
- 예시 대화가 활용되지 않음
- Temperature가 너무 높음 (0.7)
**해결**:
- 시스템 프롬프트 강화 (문체, 톤, 예시 포함)
- `example_dialogues`를 시스템 프롬프트에 명시적으로 포함
- Temperature 조정 (0.5-0.6으로 낮춤)
- Few-shot 예시 추가

## 구현 우선순위

### Phase 1: 필수 수정 (즉시)
1. ✅ {{user}} 이름 문제 - profiles 테이블 조인
2. ✅ 유저 사칭 방지 - 시스템 프롬프트 강화
3. ✅ 텍스트 잘림 문제 - 스트리밍 완료 확인

### Phase 2: 중요 수정 (1주 내)
4. ✅ 이미지 태그 렌더링 - 마크다운 파서 추가
5. ✅ 캐릭터 설정 일관성 - null 체크 및 기본값
6. ✅ 문체 일관성 - 프롬프트 강화 및 temperature 조정

## 기술 스택 추가 필요
- `react-markdown` 또는 `marked` (마크다운 파싱)
- `remark-gfm` (GitHub Flavored Markdown 지원, 선택적)

