# F4-3-2. ì´ë¯¸ì§€ ìƒì„± â€“ ì‹ ê·œ ìºë¦­í„° ìƒì„± (ì„ íƒ ì „ ìƒíƒœ)

## ëª©í‘œ
3-1ì—ì„œ êµ¬í˜„í•œ ì´ë¯¸ì§€ ìƒì„± í˜ì´ì§€ì˜ ë¡œê·¸ì¸ ìƒíƒœ í™”ë©´ì„ ì‹¤ì œ ì´ë¯¸ì§€ ìƒì„± UIë¡œ êµì²´í•œë‹¤.
í”„ë¡¬í”„íŠ¸ ì…ë ¥, ì¥ë¥´ ì„ íƒ, ì˜µì…˜(ë¹„ìœ¨/ê°œìˆ˜) ì„¤ì •, ì´ë¯¸ì§€ ìƒì„± API ì—°ë™, ì ¤ë¦¬ ì†Œëª¨ê¹Œì§€ í¬í•¨í•œë‹¤.

## Figma ë””ìì¸ ì°¸ê³  (ìŠ¤í¬ë¦°ìƒ· ê¸°ë°˜)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NYANYANG  ì¶”ì²œ  ìºë¦­í„°  ë‚´ ì»¨í…ì¸   ì´ë¯¸ì§€ ìƒì„±  ë±ƒì§€/ë¦¬ì›Œë“œ    ğŸŒ™ ğŸ”” ğŸ‘¤ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ìƒì„±ëœì´ë¯¸ì§€â”‚  [ì‹ ê·œ ìºë¦­í„° ìƒì„±]  ê¸°ì¡´ ìºë¦­í„° ìˆ˜ì •      â”‚  ì´ë¯¸ì§€ ë¹„ìœ¨     â”‚
â”‚          â”‚                                          â”‚  [1:1] 4:3     â”‚
â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   3:4 16:9 9:16â”‚
â”‚          â”‚  â”‚ë§Œë“¤ê³  ì‹¶ì€ ì´ë¯¸ì§€ì˜ íŠ¹ì§•ì„ ì°¨ë¡€ëŒ€ë¡œ  â”‚    â”‚               â”‚
â”‚ (ì‚¬ì´ë“œë°”) â”‚  â”‚ì ì–´ì£¼ì„¸ìš”. (ì„±ë³„,í¬ì¦ˆ,ì–¼êµ´,í‘œì •...)  â”‚    â”‚  ì´ë¯¸ì§€ ê°œìˆ˜    â”‚
â”‚          â”‚  â”‚                                  â”‚    â”‚  [1ê°œ] 2ê°œ     â”‚
â”‚          â”‚  â”‚ âœ¨í”„ë¡¬í”„íŠ¸ ìë™ìƒì„±   ì´ë¯¸ì§€ìƒì„±í•˜ê¸°ğŸ±140â”‚    â”‚   3ê°œ  4ê°œ     â”‚
â”‚          â”‚  â”‚                           0/1000 â”‚    â”‚               â”‚
â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚               â”‚
â”‚          â”‚                                          â”‚               â”‚
â”‚          â”‚  ì¥ë¥´ë³„ ì´ë¯¸ì§€ ìƒì„±                         â”‚               â”‚
â”‚          â”‚  ì–´ë–¤ ì¥ë¥´ì˜ ìºë¦­í„°ë¥¼ ë§Œë“¤ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?      â”‚               â”‚
â”‚          â”‚                                          â”‚               â”‚
â”‚          â”‚  [ë¡œë§¨ìŠ¤] [ì„œë¸Œì»¬ì²˜] [í˜„ëŒ€ê·¹] [íŒíƒ€ì§€]       â”‚               â”‚
â”‚          â”‚  [ì•¡ì…˜]  [ë‹¤í¬/ìŠ¤ë¦´ëŸ¬] [íë§/ì¼ìƒ] [ê²Œì„/íˆì–´ë¡œ]â”‚              â”‚
â”‚          â”‚                                          â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. íŒŒì¼ êµ¬ì¡°

### ìˆ˜ì •í•  íŒŒì¼
```
app/features/image-generation/screens/image-generation.tsx  # ë©”ì¸ í™”ë©´ í™•ì¥
```

### ìƒˆë¡œ ìƒì„±í•  íŒŒì¼
```
app/features/image-generation/components/
â”œâ”€â”€ generation-tabs.tsx        # ìƒë‹¨ íƒ­ (ì‹ ê·œ/ê¸°ì¡´)
â”œâ”€â”€ prompt-input.tsx           # í”„ë¡¬í”„íŠ¸ ì…ë ¥ ì˜ì—­
â”œâ”€â”€ genre-cards.tsx            # ì¥ë¥´ë³„ ì´ë¯¸ì§€ ì„ íƒ
â”œâ”€â”€ options-panel.tsx          # ìš°ì¸¡ ì˜µì…˜ íŒ¨ë„ (ë¹„ìœ¨/ê°œìˆ˜)
â””â”€â”€ generate-button.tsx        # ìƒì„± ë²„íŠ¼ (ë³„ë„ ë¶„ë¦¬ ì„ íƒ)

app/features/image-generation/api/
â””â”€â”€ generate.tsx               # ì´ë¯¸ì§€ ìƒì„± API ì—”ë“œí¬ì¸íŠ¸

app/features/image-generation/lib/
â””â”€â”€ constants.ts               # ì¥ë¥´, ë¹„ìœ¨, ê°œìˆ˜ ìƒìˆ˜ ì •ì˜
```

### ë¼ìš°íŠ¸ ì¶”ê°€ (app/routes.ts)
```diff
  ...prefix("/api", [
+   ...prefix("/image-generation", [
+     route("/generate", "features/image-generation/api/generate.tsx"),
+   ]),
    ...prefix("/settings", [
```

---

## 2. ìƒìˆ˜ ì •ì˜: `lib/constants.ts`

```typescript
export const GENRES = [
  { id: "romance", label: "ë¡œë§¨ìŠ¤", sub: "ìˆœì •/ì²«ì‚¬ë‘/ê°ì„±", color: "#F43F5E" },
  { id: "subculture", label: "ì„œë¸Œì»¬ì²˜", sub: "ì½”ë•/í‚¤ì¹˜/VTuber", color: "#8B5CF6" },
  { id: "modern", label: "í˜„ëŒ€ê·¹", sub: "ë¡œë§¨/ì˜¤í”¼ìŠ¤/ë‰´ì—ë¼", color: "#3B82F6" },
  { id: "fantasy", label: "íŒíƒ€ì§€", sub: "ë¡œíŒ/ì´ì„¸ê³„/ë‹¤íŒì‹œ", color: "#6366F1" },
  { id: "action", label: "ì•¡ì…˜", sub: "í•µì„ /ë°€ë¦¬/ë¬´í˜‘", color: "#EF4444" },
  { id: "dark", label: "ë‹¤í¬/ìŠ¤ë¦´ëŸ¬", sub: "ë¯¸ìŠ¤ë“œ/ë§ˆë²•", color: "#1F2937" },
  { id: "healing", label: "íë§/ì¼ìƒ", sub: "ë”°ëœ»í•œ ê°ì„±", color: "#10B981" },
  { id: "game", label: "ê²Œì„/íˆì–´ë¡œ", sub: "ê²Œì„ê°ì„±", color: "#0EA5E9" },
] as const;

export const ASPECT_RATIOS = [
  { id: "1:1", label: "1:1", width: 1024, height: 1024 },
  { id: "4:3", label: "4:3", width: 1024, height: 768 },
  { id: "3:4", label: "3:4", width: 768, height: 1024 },
  { id: "16:9", label: "16:9", width: 1024, height: 576 },
  { id: "9:16", label: "9:16", width: 576, height: 1024 },
] as const;

export const IMAGE_COUNTS = [1, 2, 3, 4] as const;

// ì´ë¯¸ì§€ 1ì¥ë‹¹ ì ¤ë¦¬ ë¹„ìš©
export const JELLY_COST_PER_IMAGE = 140;

export const MAX_PROMPT_LENGTH = 1000;
```

---

## 3. ë©”ì¸ í™”ë©´: `image-generation.tsx` (ìˆ˜ì •)

ë¡œê·¸ì¸ ìƒíƒœì˜ "ê³§ ì¶”ê°€ë©ë‹ˆë‹¤" ë¶€ë¶„ì„ ì•„ë˜ êµ¬ì¡°ë¡œ êµì²´:

```tsx
{isLoggedIn ? (
  <div className="flex h-full">
    {/* ì¤‘ì•™ ë©”ì¸ ì½˜í…ì¸  */}
    <div className="min-w-0 flex-1 overflow-y-auto">
      <div className="mx-auto max-w-[800px] px-6 py-6">
        {/* 1. ìƒë‹¨ íƒ­ */}
        <GenerationTabs activeTab={activeTab} onTabChange={setActiveTab} />

        {/* 2. í”„ë¡¬í”„íŠ¸ ì…ë ¥ ì˜ì—­ */}
        <PromptInput
          value={prompt}
          onChange={setPrompt}
          onGenerate={handleGenerate}
          onAutoGenerate={handleAutoGenerate}
          isGenerating={isGenerating}
          jellyCost={jellyCost}
        />

        {/* 3. ì¥ë¥´ë³„ ì´ë¯¸ì§€ ì„ íƒ */}
        <GenreCards
          selectedGenre={selectedGenre}
          onSelect={setSelectedGenre}
        />
      </div>
    </div>

    {/* ìš°ì¸¡ ì˜µì…˜ íŒ¨ë„ */}
    <OptionsPanel
      aspectRatio={aspectRatio}
      onAspectRatioChange={setAspectRatio}
      imageCount={imageCount}
      onImageCountChange={setImageCount}
    />
  </div>
) : (
  <LoginRequiredOverlay />
)}
```

### State ê´€ë¦¬ (useState)

```typescript
const [activeTab, setActiveTab] = useState<"new" | "edit">("new");
const [prompt, setPrompt] = useState("");
const [selectedGenre, setSelectedGenre] = useState<string | null>(null);
const [aspectRatio, setAspectRatio] = useState("1:1");
const [imageCount, setImageCount] = useState(1);
const [isGenerating, setIsGenerating] = useState(false);

const jellyCost = imageCount * JELLY_COST_PER_IMAGE;
```

---

## 4. ìƒë‹¨ íƒ­: `generation-tabs.tsx`

```tsx
interface GenerationTabsProps {
  activeTab: "new" | "edit";
  onTabChange: (tab: "new" | "edit") => void;
}

export function GenerationTabs({ activeTab, onTabChange }: GenerationTabsProps) {
  return (
    <div className="mb-6 flex border-b border-[#E9EAEB] dark:border-[#333741]">
      <button
        type="button"
        onClick={() => onTabChange("new")}
        className={`px-4 py-3 text-sm font-semibold transition-colors ${
          activeTab === "new"
            ? "border-b-2 border-[#181D27] text-[#181D27] dark:border-white dark:text-white"
            : "text-[#A4A7AE] hover:text-[#535862] dark:text-[#717680] dark:hover:text-[#94969C]"
        }`}
      >
        ì‹ ê·œ ìºë¦­í„° ìƒì„±
      </button>
      <button
        type="button"
        onClick={() => onTabChange("edit")}
        className={`px-4 py-3 text-sm font-semibold transition-colors ${
          activeTab === "edit"
            ? "border-b-2 border-[#181D27] text-[#181D27] dark:border-white dark:text-white"
            : "text-[#A4A7AE] hover:text-[#535862] dark:text-[#717680] dark:hover:text-[#94969C]"
        }`}
      >
        ê¸°ì¡´ ìºë¦­í„° ìˆ˜ì •
      </button>
    </div>
  );
}
```

---

## 5. í”„ë¡¬í”„íŠ¸ ì…ë ¥: `prompt-input.tsx`

```tsx
import { Sparkles } from "lucide-react";
import { MAX_PROMPT_LENGTH } from "../lib/constants";

interface PromptInputProps {
  value: string;
  onChange: (value: string) => void;
  onGenerate: () => void;
  onAutoGenerate: () => void;
  isGenerating: boolean;
  jellyCost: number;
}

export function PromptInput({
  value, onChange, onGenerate, onAutoGenerate, isGenerating, jellyCost,
}: PromptInputProps) {
  const canGenerate = value.trim().length > 0 && !isGenerating;

  return (
    <div className="mb-8 rounded-xl border border-[#E9EAEB] p-5 dark:border-[#333741]">
      {/* í…ìŠ¤íŠ¸ ì…ë ¥ */}
      <textarea
        value={value}
        onChange={(e) => onChange(e.target.value.slice(0, MAX_PROMPT_LENGTH))}
        placeholder="ë§Œë“¤ê³  ì‹¶ì€ ì´ë¯¸ì§€ì˜ íŠ¹ì§•ì„ ì°¨ë¡€ëŒ€ë¡œ ì ì–´ì£¼ì„¸ìš”.&#10;(ì„±ë³„, í¬ì¦ˆ, ì–¼êµ´, í‘œì •, ìì„¸, êµ¬ë„, ì˜ìƒ, ë°°ê²½ ë“±)"
        className="min-h-[80px] w-full resize-none bg-transparent text-sm text-[#181D27] placeholder:text-[#A4A7AE] focus:outline-none dark:text-white dark:placeholder:text-[#717680]"
        rows={3}
      />

      {/* í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ */}
      <div className="mt-3 flex items-center justify-between">
        {/* í”„ë¡¬í”„íŠ¸ ìë™ìƒì„± */}
        <button
          type="button"
          onClick={onAutoGenerate}
          disabled={isGenerating}
          className="flex items-center gap-1.5 rounded-lg border border-[#E9EAEB] px-3 py-2 text-sm font-medium text-[#535862] transition-colors hover:bg-[#F5F5F5] disabled:opacity-50 dark:border-[#333741] dark:text-[#D5D7DA] dark:hover:bg-[#1F242F]"
        >
          <Sparkles className="size-4" />
          í”„ë¡¬í”„íŠ¸ ìë™ìƒì„±
        </button>

        <div className="flex items-center gap-3">
          {/* ì´ë¯¸ì§€ ìƒì„±í•˜ê¸° ë²„íŠ¼ */}
          <button
            type="button"
            onClick={onGenerate}
            disabled={!canGenerate}
            className="flex items-center gap-2 rounded-lg bg-[#41C7BD] px-4 py-2 text-sm font-semibold text-white transition-colors hover:bg-[#38b5ab] disabled:cursor-not-allowed disabled:bg-[#E9EAEB] disabled:text-[#A4A7AE] dark:disabled:bg-[#333741] dark:disabled:text-[#717680]"
          >
            ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°
            <span className="flex items-center gap-1">
              ğŸ± {jellyCost}
            </span>
          </button>
        </div>
      </div>

      {/* ê¸€ììˆ˜ ì¹´ìš´íŠ¸ */}
      <div className="mt-2 text-right text-xs text-[#A4A7AE] dark:text-[#717680]">
        {value.length}/{MAX_PROMPT_LENGTH}
      </div>
    </div>
  );
}
```

---

## 6. ì¥ë¥´ë³„ ì´ë¯¸ì§€ ì„ íƒ: `genre-cards.tsx`

```tsx
import { GENRES } from "../lib/constants";

interface GenreCardsProps {
  selectedGenre: string | null;
  onSelect: (genreId: string | null) => void;
}

export function GenreCards({ selectedGenre, onSelect }: GenreCardsProps) {
  return (
    <section>
      <h3 className="mb-1 text-lg font-bold text-[#181D27] dark:text-white">
        ì¥ë¥´ë³„ ì´ë¯¸ì§€ ìƒì„±
      </h3>
      <p className="mb-4 text-sm text-[#535862] dark:text-[#94969C]">
        ì–´ë–¤ ì¥ë¥´ì˜ ìºë¦­í„°ë¥¼ ë§Œë“¤ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?
      </p>

      <div className="grid grid-cols-2 gap-3 sm:grid-cols-4">
        {GENRES.map((genre) => (
          <button
            key={genre.id}
            type="button"
            onClick={() =>
              onSelect(selectedGenre === genre.id ? null : genre.id)
            }
            className={`group relative aspect-[4/5] overflow-hidden rounded-xl transition-all ${
              selectedGenre === genre.id
                ? "ring-2 ring-[#41C7BD] ring-offset-2 dark:ring-offset-[#0C111D]"
                : "hover:scale-[1.02]"
            }`}
          >
            {/* Placeholder ë°°ê²½ (ë‚˜ì¤‘ì— ì‹¤ì œ ì´ë¯¸ì§€ë¡œ êµì²´) */}
            <div
              className="absolute inset-0"
              style={{
                background: `linear-gradient(135deg, ${genre.color}CC, ${genre.color}66)`,
              }}
            />

            {/* í•˜ë‹¨ í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ */}
            <div className="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/70 to-transparent p-3 pt-8">
              <p className="text-sm font-bold text-white">
                {genre.label}{" "}
                <span className="text-xs font-normal text-white/70">
                  ({genre.sub})
                </span>
              </p>
            </div>
          </button>
        ))}
      </div>
    </section>
  );
}
```

---

## 7. ìš°ì¸¡ ì˜µì…˜ íŒ¨ë„: `options-panel.tsx`

```tsx
import { ASPECT_RATIOS, IMAGE_COUNTS } from "../lib/constants";

interface OptionsPanelProps {
  aspectRatio: string;
  onAspectRatioChange: (ratio: string) => void;
  imageCount: number;
  onImageCountChange: (count: number) => void;
}

export function OptionsPanel({
  aspectRatio, onAspectRatioChange,
  imageCount, onImageCountChange,
}: OptionsPanelProps) {
  return (
    <aside className="hidden w-[180px] shrink-0 border-l border-[#E9EAEB] bg-white p-4 dark:border-[#333741] dark:bg-[#0C111D] lg:block">
      {/* ì´ë¯¸ì§€ ë¹„ìœ¨ */}
      <div className="mb-6">
        <h4 className="mb-3 text-sm font-semibold text-[#181D27] dark:text-white">
          ì´ë¯¸ì§€ ë¹„ìœ¨
        </h4>
        <div className="grid grid-cols-3 gap-2">
          {ASPECT_RATIOS.map((ratio) => (
            <button
              key={ratio.id}
              type="button"
              onClick={() => onAspectRatioChange(ratio.id)}
              className={`flex flex-col items-center gap-1 rounded-lg border p-2 text-xs transition-colors ${
                aspectRatio === ratio.id
                  ? "border-[#41C7BD] bg-[#41C7BD]/10 text-[#41C7BD]"
                  : "border-[#E9EAEB] text-[#535862] hover:border-[#D5D7DA] dark:border-[#333741] dark:text-[#94969C] dark:hover:border-[#414651]"
              }`}
            >
              {/* ë¹„ìœ¨ ì•„ì´ì½˜ (ë¹„ìœ¨ì— ë§ëŠ” ì‚¬ê°í˜•) */}
              <RatioIcon ratio={ratio.id} selected={aspectRatio === ratio.id} />
              <span>{ratio.label}</span>
            </button>
          ))}
        </div>
      </div>

      {/* ì´ë¯¸ì§€ ê°œìˆ˜ */}
      <div>
        <h4 className="mb-3 text-sm font-semibold text-[#181D27] dark:text-white">
          ì´ë¯¸ì§€ ê°œìˆ˜
        </h4>
        <div className="grid grid-cols-4 gap-2">
          {IMAGE_COUNTS.map((count) => (
            <button
              key={count}
              type="button"
              onClick={() => onImageCountChange(count)}
              className={`rounded-lg border px-2 py-1.5 text-xs font-medium transition-colors ${
                imageCount === count
                  ? "border-[#41C7BD] bg-[#41C7BD] text-white"
                  : "border-[#E9EAEB] text-[#535862] hover:border-[#D5D7DA] dark:border-[#333741] dark:text-[#94969C] dark:hover:border-[#414651]"
              }`}
            >
              {count}ê°œ
            </button>
          ))}
        </div>
      </div>
    </aside>
  );
}

/** ë¹„ìœ¨ì— ë§ëŠ” ì‚¬ê°í˜• ì•„ì´ì½˜ */
function RatioIcon({ ratio, selected }: { ratio: string; selected: boolean }) {
  const sizes: Record<string, { w: number; h: number }> = {
    "1:1": { w: 20, h: 20 },
    "4:3": { w: 24, h: 18 },
    "3:4": { w: 18, h: 24 },
    "16:9": { w: 28, h: 16 },
    "9:16": { w: 16, h: 28 },
  };
  const s = sizes[ratio] || sizes["1:1"];
  return (
    <div
      className={`rounded-sm border ${
        selected ? "border-[#41C7BD]" : "border-[#D5D7DA] dark:border-[#414651]"
      }`}
      style={{ width: s.w, height: s.h }}
    />
  );
}
```

---

## 8. ì´ë¯¸ì§€ ìƒì„± API: `api/generate.tsx`

### íŒ¨í„´ ì°¸ê³ 
- í¬ì¸íŠ¸ ì°¨ê°: `app/features/chat/api/chat.tsx` (lines 303-564)
- í¬ì¸íŠ¸ ì‚¬ìš© API: `app/features/points/api/usage.tsx`

### êµ¬í˜„

```tsx
import type { Route } from "./+types/generate";
import { data } from "react-router";
import { openai } from "@ai-sdk/openai";
import { experimental_generateImage as generateImage } from "ai";
import { eq } from "drizzle-orm";

import drizzle from "~/core/db/drizzle-client.server";
import { requireAuthentication } from "~/core/lib/guards.server";
import makeServerClient from "~/core/lib/supa-client.server";
import { userPoints, pointTransactions } from "~/features/points/schema";
import { JELLY_COST_PER_IMAGE, ASPECT_RATIOS } from "../lib/constants";

export async function action({ request }: Route.ActionArgs) {
  // 1. ì¸ì¦ í™•ì¸
  const [client, headers] = makeServerClient(request);
  const { data: { user } } = await client.auth.getUser();
  if (!user) return data({ error: "Unauthorized" }, { status: 401, headers });

  // 2. ìš”ì²­ íŒŒì‹±
  const body = await request.json();
  const { prompt, genre, aspectRatio = "1:1", imageCount = 1 } = body;

  if (!prompt || prompt.trim().length === 0) {
    return data({ error: "í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" }, { status: 400, headers });
  }

  // 3. ë¹„ìš© ê³„ì‚° ë° ì”ì•¡ í™•ì¸
  const totalCost = imageCount * JELLY_COST_PER_IMAGE;

  const [pointRecord] = await drizzle
    .select()
    .from(userPoints)
    .where(eq(userPoints.user_id, user.id));

  if (!pointRecord || pointRecord.current_balance < totalCost) {
    return data(
      { error: "ì ¤ë¦¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤", required: totalCost, balance: pointRecord?.current_balance ?? 0 },
      { status: 400, headers }
    );
  }

  // 4. ë¹„ìœ¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const ratioConfig = ASPECT_RATIOS.find((r) => r.id === aspectRatio) || ASPECT_RATIOS[0];

  // 5. í”„ë¡¬í”„íŠ¸ êµ¬ì„± (ì¥ë¥´ ì»¨í…ìŠ¤íŠ¸ í¬í•¨)
  const fullPrompt = genre
    ? `${genre} genre anime character: ${prompt}`
    : `anime character: ${prompt}`;

  try {
    // 6. ì´ë¯¸ì§€ ìƒì„± (OpenAI DALL-E)
    const result = await generateImage({
      model: openai.image("dall-e-3"),
      prompt: fullPrompt,
      n: imageCount,
      size: `${ratioConfig.width}x${ratioConfig.height}`,
    });

    // 7. í¬ì¸íŠ¸ ì°¨ê°
    const newBalance = pointRecord.current_balance - totalCost;
    const newTotalSpent = pointRecord.total_spent + totalCost;

    await drizzle
      .update(userPoints)
      .set({ current_balance: newBalance, total_spent: newTotalSpent })
      .where(eq(userPoints.user_id, user.id));

    await drizzle.insert(pointTransactions).values({
      user_id: user.id,
      amount: -totalCost,
      balance_after: newBalance,
      type: "usage",
      reason: `ì´ë¯¸ì§€ ìƒì„± (${imageCount}ì¥)`,
      reference_id: `img_gen_${Date.now()}`,
    });

    // 8. ê²°ê³¼ ë°˜í™˜
    return data(
      {
        images: result.images.map((img) => ({
          base64: img.base64,
          // ë˜ëŠ” URL ë°©ì‹ì´ë©´ img.url
        })),
        cost: totalCost,
        remainingBalance: newBalance,
      },
      { headers }
    );
  } catch (error) {
    console.error("Image generation error:", error);
    return data(
      { error: "ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”." },
      { status: 500, headers }
    );
  }
}
```

### ì¤‘ìš” ì°¸ê³ 
- `experimental_generateImage`ëŠ” Vercel AI SDK v5ì—ì„œ ì œê³µ
- ë§Œì•½ importì´ ì•ˆ ë˜ë©´ OpenAI APIë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ëŒ€ì²´:
  ```typescript
  import OpenAI from "openai";
  const client = new OpenAI();
  const response = await client.images.generate({
    model: "dall-e-3",
    prompt: fullPrompt,
    n: imageCount,
    size: `${ratioConfig.width}x${ratioConfig.height}`,
  });
  ```
- `OPENAI_API_KEY` í™˜ê²½ë³€ìˆ˜ê°€ `.env`ì— ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ í•¨

---

## 9. í”„ë¡¬í”„íŠ¸ ìë™ìƒì„± ê¸°ëŠ¥

ë©”ì¸ í™”ë©´ì˜ `handleAutoGenerate`ì—ì„œ ê¸°ì¡´ ì±„íŒ… AIë¥¼ í™œìš©í•˜ì—¬ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•œë‹¤.
ê°„ë‹¨í•œ êµ¬í˜„:

```typescript
async function handleAutoGenerate() {
  if (!selectedGenre) return;

  setIsGenerating(true);
  try {
    // ì¥ë¥´ ê¸°ë°˜ í”„ë¡¬í”„íŠ¸ ìë™ ìƒì„± (ì„œë²„ API ë˜ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê°„ë‹¨íˆ)
    const genre = GENRES.find((g) => g.id === selectedGenre);
    const suggestions = [
      `${genre?.label} ì¥ë¥´ì˜ ìºë¦­í„°, ì‹ ë¹„ë¡œìš´ ë¶„ìœ„ê¸°, ê¸´ ë¨¸ë¦¬ì¹´ë½, í™˜ìƒì ì¸ ë°°ê²½`,
      `${genre?.label} ìŠ¤íƒ€ì¼ì˜ ìºë¦­í„°, ê°•ë ¬í•œ ëˆˆë¹›, ë„ì‹œ ë°°ê²½, í˜„ëŒ€ì  ì˜ìƒ`,
      // ... ì¥ë¥´ë³„ ìƒ˜í”Œ í”„ë¡¬í”„íŠ¸
    ];
    setPrompt(suggestions[Math.floor(Math.random() * suggestions.length)]);
  } finally {
    setIsGenerating(false);
  }
}
```

> ì¶”í›„ AI ê¸°ë°˜ í”„ë¡¬í”„íŠ¸ ìƒì„± APIë¥¼ ë³„ë„ë¡œ ë§Œë“¤ ìˆ˜ë„ ìˆìŒ (GPTë¡œ í”„ë¡¬í”„íŠ¸ ì¶”ì²œ)

---

## 10. ìƒ‰ìƒ ì°¸ê³ 

| ìš©ë„ | Light | Dark |
|------|-------|------|
| íƒ­ í™œì„± border | `border-[#181D27]` | `dark:border-white` |
| íƒ­ ë¹„í™œì„± í…ìŠ¤íŠ¸ | `text-[#A4A7AE]` | `dark:text-[#717680]` |
| ì…ë ¥ border | `border-[#E9EAEB]` | `dark:border-[#333741]` |
| CTA ë²„íŠ¼ (ë¯¼íŠ¸) | `bg-[#41C7BD]` | ë™ì¼ |
| CTA ë¹„í™œì„± | `bg-[#E9EAEB] text-[#A4A7AE]` | `dark:bg-[#333741] dark:text-[#717680]` |
| ì˜µì…˜ ì„ íƒ | `border-[#41C7BD] bg-[#41C7BD]/10` | ë™ì¼ |
| ì˜µì…˜ ê°œìˆ˜ ì„ íƒ | `bg-[#41C7BD] text-white` | ë™ì¼ |
| ìš°ì¸¡ íŒ¨ë„ ë°°ê²½ | `bg-white` | `dark:bg-[#0C111D]` |
| ì ¤ë¦¬ ì•„ì´ì½˜ | ğŸ± ì´ëª¨ì§€ (ê¸°ì¡´ íŒ¨í„´) | ë™ì¼ |

---

## 11. import ê·œì¹™

```typescript
// Supabase client
import makeServerClient from "~/core/lib/supa-client.server";
// DB client
import drizzle from "~/core/db/drizzle-client.server";
// Auth guard
import { requireAuthentication } from "~/core/lib/guards.server";
// Points schema
import { userPoints, pointTransactions } from "~/features/points/schema";
// ê¸°ì¡´ ì»´í¬ë„ŒíŠ¸
import { ImageGenerationSidebar } from "../components/image-generation-sidebar";
import { LoginRequiredOverlay } from "../components/login-required-overlay";
```

---

## 12. í™˜ê²½ ë³€ìˆ˜ (.envì— ì¶”ê°€ í•„ìš”)

```env
OPENAI_API_KEY=sk-...your-key-here...
```

---

## 13. ê²€ì¦ ë°©ë²•

1. `npm run typecheck` â€” íƒ€ì… ì—ëŸ¬ ì—†ì–´ì•¼ í•¨
2. `npm run dev` ì‹¤í–‰ í›„:
   - ë¹„ë¡œê·¸ì¸: ê¸°ì¡´ 3-1 blur + ëª¨ë‹¬ ìœ ì§€ë˜ëŠ”ì§€ í™•ì¸
   - ë¡œê·¸ì¸ í›„ `/image-generation`:
     - ìƒë‹¨ íƒ­ 2ê°œ í‘œì‹œ ("ì‹ ê·œ ìºë¦­í„° ìƒì„±" í™œì„±)
     - í”„ë¡¬í”„íŠ¸ ì…ë ¥ ì˜ì—­ í‘œì‹œ (placeholder í…ìŠ¤íŠ¸, 0/1000)
     - í”„ë¡¬í”„íŠ¸ ë¹„ì–´ìˆì„ ë•Œ "ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°" ë²„íŠ¼ ë¹„í™œì„±
     - ì¥ë¥´ ì¹´ë“œ 8ê°œ (placeholder ê·¸ë¼ë°ì´ì…˜)
     - ìš°ì¸¡ íŒ¨ë„: ë¹„ìœ¨ 5ê°œ(1:1 ê¸°ë³¸ì„ íƒ), ê°œìˆ˜ 4ê°œ(1ê°œ ê¸°ë³¸ì„ íƒ)
     - ì¥ë¥´ ì¹´ë“œ í´ë¦­ ì‹œ ì„ íƒ í‘œì‹œ (ë¯¼íŠ¸ ring)
     - í”„ë¡¬í”„íŠ¸ ì…ë ¥ í›„ ìƒì„± ë²„íŠ¼ í™œì„±í™”
3. API í…ŒìŠ¤íŠ¸ (OPENAI_API_KEY ì„¤ì • í›„):
   - í”„ë¡¬í”„íŠ¸ ì…ë ¥ + ìƒì„± ë²„íŠ¼ â†’ ì´ë¯¸ì§€ ìƒì„± í™•ì¸
   - ì ¤ë¦¬ ì°¨ê° í™•ì¸

---

## ì°¸ê³  íŒŒì¼

- ë©”ì¸ í™”ë©´ (3-1): `app/features/image-generation/screens/image-generation.tsx`
- ì‚¬ì´ë“œë°”: `app/features/image-generation/components/image-generation-sidebar.tsx`
- ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´: `app/features/image-generation/components/login-required-overlay.tsx`
- ì±„íŒ… API (AI + í¬ì¸íŠ¸ íŒ¨í„´): `app/features/chat/api/chat.tsx`
- í¬ì¸íŠ¸ ìŠ¤í‚¤ë§ˆ: `app/features/points/schema.ts`
- í¬ì¸íŠ¸ ì‚¬ìš© API: `app/features/points/api/usage.tsx`
- í™ˆ ë ˆì´ì•„ì›ƒ íŒ¨í„´: `app/features/home/screens/home.tsx`
- ê¸°ì¡´ ë¼ìš°íŠ¸: `app/routes.ts`
